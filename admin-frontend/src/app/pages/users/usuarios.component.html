<div class="dashboard-container" *ngIf="!loading; else cargando">
  <main class="main-content">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-left">
        <h2>Usuarios</h2>
        <div class="greeting">
          <p class="welcome">Bienvenido, <strong>{{ nombreUsuario }}</strong></p>
          <p class="time">{{ horaActual }} | {{ zonaHoraria }}</p>
        </div>
      </div>
      <div class="header-right">
        <app-clock></app-clock>
      </div>
    </header>

    <!-- Resumen -->
    <section class="neu-section">
      <div class="stats">
        <div class="stat-card">
          <i class="bi bi-people-fill icon"></i>
          <h3>{{ resumen.total }}</h3>
          <p>Total usuarios</p>
        </div>
        <div class="stat-card">
          <i class="bi bi-person-badge-fill icon"></i>
          <h3>{{ resumen.admins }}</h3>
          <p>Administradores</p>
        </div>
        <div class="stat-card">
          <i class="bi bi-person-video3 icon"></i>
          <h3>{{ resumen.comisionistas }}</h3>
          <p>Comisionistas</p>
        </div>
        <div class="stat-card">
          <i class="bi bi-people icon"></i>
          <h3>{{ resumen.inversionistas }}</h3>
          <p>Inversionistas</p>
        </div>
      </div>
    </section>

    <!-- Filtros -->
    <section class="neu-section">
      <div class="filters-bar">
        <div class="search-bar">
          <input
            type="text"
            placeholder="üîç Buscar por nombre, correo, ciudad, etc."
            [(ngModel)]="q"
            (input)="onSearchInput()"
          />
        </div>

        <div class="type-pills">
          <button
            *ngFor="let p of tiposPills"
            class="pill"
            [class.active]="tipo === p.value"
            (click)="setTipo(p.value)"
          >
            <i class="bi {{ p.icon }}"></i> {{ p.label }}
          </button>
        </div>

        <div class="other-controls">
          <label>Mostrar:
            <select [(ngModel)]="limit" (change)="cambiarLimite(+limit)">
              <option [value]="10">10</option>
              <option [value]="25">25</option>
              <option [value]="50">50</option>
            </select>
          </label>
        </div>

          <button class="neo-btn neo-btn--download" (click)="openInviteModal()">
    + Invitar admin
  </button>
      </div>

      <!-- Tabla -->
      <table class="neu-table" *ngIf="data.length; else sinDatos">
        <thead>
          <tr>
            <th (click)="ordenarPor('nombre')">
              Nombre <i class="bi" [ngClass]="sortIcon('nombre')"></i>
            </th>
            <th (click)="ordenarPor('correo')">
              Correo <i class="bi" [ngClass]="sortIcon('correo')"></i>
            </th>
            <th (click)="ordenarPor('tipo')">
              Tipo <i class="bi" [ngClass]="sortIcon('tipo')"></i>
            </th>
            <th (click)="ordenarPor('saldo')">
              Saldo <i class="bi" [ngClass]="sortIcon('saldo')"></i>
            </th>
            <th (click)="ordenarPor('ciudad')">
              Ciudad <i class="bi" [ngClass]="sortIcon('ciudad')"></i>
            </th>
            <th (click)="ordenarPor('pais')">
              Pa√≠s <i class="bi" [ngClass]="sortIcon('pais')"></i>
            </th>
            <th (click)="ordenarPor('fecha_alta')">
              Alta <i class="bi" [ngClass]="sortIcon('fecha_alta')"></i>
            </th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let u of data; trackBy: trackById">
            <td>{{ u.nombre }}</td>
            <td class="ellipsis">{{ u.correo }}</td>
            <td>
              <span class="tipo-badge" [ngClass]="tipoBadgeClass(u.tipo)">
                {{ u.tipo }}
              </span>
            </td>
            <td>{{ (u.saldo ?? 0) | currency:'USD':'symbol':'1.0-2' }}</td>
            <td>{{ u.ciudad || '-' }}</td>
            <td>{{ u.pais || '-' }}</td>
            <td>{{ u.fecha_alta | date:'dd/MM/yy, HH:mm':'America/Bogota' }}</td>
          </tr>
        </tbody>
      </table>

      <ng-template #sinDatos>
        <p>No hay usuarios que coincidan con tu b√∫squeda.</p>
      </ng-template>

      <!-- Paginaci√≥n -->
      <div class="pagination">
        <button class="page-btn" (click)="cambiarPagina(-1)" [disabled]="page <= 1">
          <i class="bi bi-chevron-left"></i>
        </button>
        <span>P√°gina {{ page }} / {{ total_pages }} ‚Äî {{ total }} usuarios</span>
        <button class="page-btn" (click)="cambiarPagina(1)" [disabled]="page >= total_pages">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </section>
  </main>
</div>

<ng-template #cargando>
  <div class="loading-container">
    <div class="loader-card">
      <div class="circle"></div>
      <div class="text">Cargando usuarios...</div>
    </div>
  </div>
</ng-template>


<!-- Modal Invitar Admin -->
<div class="neo-modal__backdrop" *ngIf="showInviteModal" (click)="closeInviteModal()">
  <div class="neo-modal" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
    <div class="neo-modal__header">
      <h3>Invitar Administrador</h3>
      <button class="neo-close" (click)="closeInviteModal()" aria-label="Cerrar">‚úñ</button>
    </div>

    <div class="neo-modal__body">
      <div class="form-group">
        <label>Nombre completo</label>
        <input
          class="neu-input-inset"
          [(ngModel)]="inviteNombre"
          name="inviteNombre"
          placeholder="Ej. Ana P√©rez"
          autocomplete="off"
          required
        />
      </div>

      <div class="form-group">
        <label>Correo</label>
        <input
          class="neu-input-inset"
          [(ngModel)]="inviteCorreo"
          name="inviteCorreo"
          placeholder="ana@empresa.com"
          type="email"
          autocomplete="off"
          required
        />
      </div>

      <p class="hint">
        Se enviar√° una contrase√±a temporal y la invitaci√≥n al correo.
      </p>
      <p class="error" *ngIf="inviteError">{{ inviteError }}</p>
      <p class="ok" *ngIf="inviteOk">{{ inviteOk }}</p>
    </div>

    <div class="neo-modal__footer">
      <button class="neo-btn" (click)="closeInviteModal()" [disabled]="inviteLoading">Cancelar</button>
      <button
        class="neo-btn neo-btn--download"
        (click)="submitInvite()"
        [disabled]="!isInviteValid() || inviteLoading"
      >
        <span *ngIf="!inviteLoading">Enviar invitaci√≥n</span>
        <span *ngIf="inviteLoading" class="neo-spinner"></span>
        <span *ngIf="inviteLoading"> Enviando‚Ä¶</span>
      </button>
    </div>
  </div>
</div>
