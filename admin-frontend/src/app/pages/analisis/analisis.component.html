<div class="dashboard-container" *ngIf="!loading; else cargando">
  <main class="main-content">

    <!-- ðŸŸ£ Header -->
    <header class="dashboard-header">
      <div class="header-left">
        <h2>AnÃ¡lisis</h2>
        <div class="greeting">
          <p class="welcome">Bienvenido, <strong>{{ nombreUsuario }}</strong></p>
          <p class="time">{{ horaActual }} | {{ zona }}</p>
        </div>
      </div>
      <div class="header-right">
        <app-clock></app-clock>
      </div>
    </header>

    <!-- PestaÃ±as -->
    <div class="tabs">
      <button class="pill" [class.active]="active==='ACCIONES'" (click)="setTab('ACCIONES')">Acciones actuales</button>
      <button class="pill" [class.active]="active==='ORDENES'"  (click)="setTab('ORDENES')">Historial de Ã³rdenes</button>
      <button class="pill" [class.active]="active==='MOVIMIENTOS'" (click)="setTab('MOVIMIENTOS')">Movimientos</button>
      <button class="pill" [class.active]="active==='TOP'" (click)="setTab('TOP')">Top empresas</button>
    </div>

    <!-- â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
         â”‚                       TAB: ACCIONES                        â”‚
         â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ -->
    <section class="neu-section" *ngIf="active==='ACCIONES'">
      <!-- ðŸ”Ž Filtros -->
      <div class="filters-bar">
        <input class="neu-input-inset" placeholder="Buscar por empresa o inversionista..."
               [(ngModel)]="fAcciones.q" (input)="applyAcciones()" />
        <label>Mostrar:
          <select [(ngModel)]="aLimit" (change)="applyAcciones()">
            <option [value]="10">10</option><option [value]="25">25</option><option [value]="50">50</option>
          </select>
        </label>
      </div>

      <!-- ðŸ“ˆ GrÃ¡fica -->
      <div class="chart-card"><canvas id="chAcciones"></canvas></div>

      <!-- ðŸ“‹ Tabla -->
      <table class="neu-table" *ngIf="accionesFiltradas.length; else sinAcciones">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Inversionista</th>
            <th>Cant. acciones</th>
            <th>Precio actual</th>
            <th>Valor total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let a of accionesFiltradas">
            <td>{{ a.empresa }}</td>
            <td>{{ a.inversionista }}</td>
            <td>{{ a.cantidad_acciones }}</td>
            <td>{{ a.precio_actual | currency:'USD' }}</td>
            <td>{{ a.valor_total | currency:'USD' }}</td>
          </tr>
        </tbody>
      </table>
      <ng-template #sinAcciones><p>No hay datos de acciones.</p></ng-template>

      <!-- â­ PaginaciÃ³n -->
      <div class="pagination">
        <button class="page-btn" (click)="aPag(-1)" [disabled]="aPage<=1"><i class="bi bi-chevron-left"></i></button>
        <span>PÃ¡gina {{ aPage }} / {{ aPages }} â€” {{ aTotal }} filas</span>
        <button class="page-btn" (click)="aPag(1)" [disabled]="aPage>=aPages"><i class="bi bi-chevron-right"></i></button>
      </div>
    </section>


    <!-- â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
         â”‚                     TAB: MOVIMIENTOS                        â”‚
         â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ -->
    <section class="neu-section" *ngIf="active==='MOVIMIENTOS'">
      <!-- ðŸ”Ž Filtros -->
      <div class="filters-bar">
        <input type="number" class="neu-input-inset" placeholder="ID Inversionista"
               [(ngModel)]="fMovs.inversionista_id" (keyup.enter)="loadTab('MOVIMIENTOS')" />
        <input type="date" [(ngModel)]="fMovs.desde" (change)="loadTab('MOVIMIENTOS')" />
        <input type="date" [(ngModel)]="fMovs.hasta" (change)="loadTab('MOVIMIENTOS')" />
        <input class="neu-input-inset" placeholder="Buscar en tabla..."
               [(ngModel)]="fMovs.q" (input)="applyMovs()" />
        <label>Mostrar:
          <select [(ngModel)]="mLimit" (change)="applyMovs()">
            <option [value]="10">10</option><option [value]="25">25</option><option [value]="50">50</option>
          </select>
        </label>
      </div>

      <!-- ðŸ“ˆ GrÃ¡fica -->
      <div class="chart-card"><canvas id="chMovs"></canvas></div>

      <!-- ðŸ“‹ Tabla -->
      <table class="neu-table" *ngIf="movsFiltradas.length; else sinMovs">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Inversionista</th>
            <th>Tipo</th>
            <th>Monto</th>
            <th>Empresa</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let m of movsFiltradas">
            <td>{{ m.fecha | date:'dd/MM/yy, HH:mm':'America/Bogota' }}</td>
<td>{{ m.nombre_inversionista }}</td>
            <td>{{ m.tipo }}</td>
            <td>{{ m.monto | currency:'USD' }}</td>
            <td>{{ m.empresa || '-' }}</td>
          </tr>
        </tbody>
      </table>
      <ng-template #sinMovs><p>No hay movimientos que coincidan con tu bÃºsqueda.</p></ng-template>

      <!-- â­ PaginaciÃ³n -->
      <div class="pagination">
        <button class="page-btn" (click)="mPag(-1)" [disabled]="mPage<=1"><i class="bi bi-chevron-left"></i></button>
        <span>PÃ¡gina {{ mPage }} / {{ mPages }} â€” {{ mTotal }} filas</span>
        <button class="page-btn" (click)="mPag(1)" [disabled]="mPage>=mPages"><i class="bi bi-chevron-right"></i></button>
      </div>
    </section>

    <!-- â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
         â”‚                     TAB: TOP EMPRESAS                       â”‚
         â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ -->
    <section class="neu-section" *ngIf="active==='TOP'">
      <!-- ðŸ”Ž Filtros -->
      <div class="filters-bar">
        <input class="neu-input-inset" placeholder="Buscar empresa..."
               [(ngModel)]="fTop.q" (input)="applyTop()" />
        <label>Mostrar:
          <select [(ngModel)]="tLimit" (change)="applyTop()">
            <option [value]="10">10</option><option [value]="25">25</option><option [value]="50">50</option>
          </select>
        </label>
      </div>

      <!-- ðŸ“ˆ GrÃ¡fica -->
      <div class="chart-card"><canvas id="chTop"></canvas></div>

      <!-- ðŸ“‹ Tabla -->
      <table class="neu-table" *ngIf="topFiltradas.length; else sinTop">
        <thead>
          <tr>
            <th>#</th>
            <th>Empresa</th>
            <th>Ã“rdenes</th>
            <th>Monto total</th>
            <th>Comisiones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let t of topFiltradas; let i = index">
            <td>{{ (tPage - 1) * tLimit + i + 1 }}</td>
            <td>{{ t.empresa }}</td>
            <td>{{ t.total_ordenes }}</td>
<td>{{ t.volumen | currency:'USD' }}</td>
            <td>{{ t.total_comisiones | currency:'USD' }}</td>
          </tr>
        </tbody>
      </table>
      <ng-template #sinTop><p>No hay empresas que coincidan con tu bÃºsqueda.</p></ng-template>

      <!-- â­ PaginaciÃ³n -->
      <div class="pagination">
        <button class="page-btn" (click)="tPag(-1)" [disabled]="tPage<=1"><i class="bi bi-chevron-left"></i></button>
        <span>PÃ¡gina {{ tPage }} / {{ tPages }} â€” {{ tTotal }} filas</span>
        <button class="page-btn" (click)="tPag(1)" [disabled]="tPage>=tPages"><i class="bi bi-chevron-right"></i></button>
      </div>
    </section>

  </main>
</div>

<ng-template #cargando>
  <div class="loading-container">
    <div class="loader-card">
      <div class="circle"></div>
      <div class="text">Cargando...</div>
    </div>
  </div>
</ng-template>
